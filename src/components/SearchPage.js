\nimport React, { useState, useEffect, useMemo, useRef } from \'react\';\nimport { useLocation } from \'react-router-dom\';\nimport useRealtimeDB from \'../hooks/useRealtimeDB.js\';\nimport useSuitAnimations from \'../hooks/useSuitAnimations.js\';\nimport SuitCard, { SuitCardSkeleton } from \'./SuitCard.js\';\nimport { gsap } from \'gsap\';\nimport { usePopper } from \'react-popper\';\n\n// --- Iconos (reutilizados) ---\nconst SortIcon = (props) => <svg {...props} xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" strokeWidth={1.5} stroke=\"currentColor\"><path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M3 7.5L7.5 3m0 0L12 7.5M7.5 3v13.5m13.5 0L16.5 21m0 0L12 16.5m4.5 4.5V7.5\" /></svg>;\nconst CloseIcon = () => <svg xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" strokeWidth={2} stroke=\"currentColor\" className=\"w-6 h-6\"><path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M6 18L18 6M6 6l12 12\" /></svg>;\nconst CheckIcon = () => <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 20 20\" fill=\"currentColor\" className=\"w-5 h-5\"><path fillRule=\"evenodd\" d=\"M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.052-.143z\" clipRule=\"evenodd\" /></svg>;\nconst AnimatedFilterIcon = () => {\n    const iconRef = useRef(null);\n    useEffect(() => {\n        const tl = gsap.timeline({ paused: true, repeat: 1, yoyo: true });\n        gsap.utils.toArray(\".knob\", iconRef.current).forEach((knob, i) => {\n            tl.to(knob, { attr: { cx: i % 2 === 0 ? 17 : 7 } }, 0);\n        });\n        const handleMouseEnter = () => tl.play(0);\n        const currentIconRef = iconRef.current;\n        currentIconRef.addEventListener(\'mouseenter\', handleMouseEnter);\n        return () => currentIconRef.removeEventListener(\'mouseenter\', handleMouseEnter);\n    }, []);\n    return (\n        <svg ref={iconRef} xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" strokeWidth={1.5} stroke=\"currentColor\" className=\"w-5 h-5\">\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5\" /><path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M10.5 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5\" /><path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M10.5 18h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5\" />\n            <circle className=\"knob\" cx=\"10.5\" cy=\"6\" r=\"1.5\" fill=\"currentColor\" /><circle className=\"knob\" cx=\"10.5\" cy=\"12\" r=\"1.5\" fill=\"currentColor\" /><circle className=\"knob\" cx=\"10.5\" cy=\"18\" r=\"1.5\" fill=\"currentColor\" />\n        </svg>\n    );\n};\n\n// --- Dropdown de Ordenación (reutilizado) ---\nconst SortDropdown = ({ selected, onSelect }) => {\n    const options = { \'default\': \'Relevancia\', \'price-asc\': \'Precio: Menor a Mayor\', \'price-desc\': \'Precio: Mayor a Menor\' };\n    const [isOpen, setIsOpen] = useState(false);\n    const popperRef = useRef(null), dropdownRef = useRef(null);\n    const { styles, attributes } = usePopper(dropdownRef.current, popperRef.current, { placement: \'bottom-end\', modifiers: [{ name: \'offset\', options: { offset: [0, 8] } }] });\n    useEffect(() => {\n        const handleClickOutside = (e) => { if (dropdownRef.current && !dropdownRef.current.contains(e.target)) setIsOpen(false); };\n        document.addEventListener(\'mousedown\', handleClickOutside);\n        gsap.set(popperRef.current, { autoAlpha: 0, scale: 0.95 });\n        return () => document.removeEventListener(\'mousedown\', handleClickOutside);\n    }, []);\n    useEffect(() => {\n        gsap.to(popperRef.current, { autoAlpha: isOpen ? 1 : 0, scale: isOpen ? 1 : 0.95, duration: 0.2, ease: \'power2.out\' });\n    }, [isOpen]);\n    return (\n        <div className=\"relative\" ref={dropdownRef}>\n            <button onClick={() => setIsOpen(true)} className=\"flex items-center justify-between w-full h-10 px-4 rounded-full bg-surface-container-high hover:bg-surface-container-highest transition-colors text-sm font-medium text-on-surface focus:outline-none focus:ring-2 focus:ring-primary\">\n                <span>{options[selected]}</span><SortIcon className={`h-5 w-5 text-on-surface-variant transition-transform duration-300 ${isOpen ? \'rotate-180\' : \'\'}`} />\n            </button>\n            <div ref={popperRef} style={styles.popper} {...attributes.popper} className=\"z-10 w-64 bg-surface-container-high rounded-xl shadow-lg border border-outline/30 overflow-hidden\">\n                {Object.entries(options).map(([key, value]) => (<button key={key} onClick={() => { onSelect(key); setIsOpen(false); }} className=\"flex items-center justify-between w-full text-left px-4 py-2.5 text-sm font-medium text-on-surface-variant hover:bg-primary/10 hover:text-on-surface transition-colors\ Dduration-150\"><span>{value}</span>{selected === key && <CheckIcon/>}</button>))}\n            </div>\n        </div>\n    );\n}\n\n// --- COMPONENTES DE FILTRO MODERNIZADOS ---\nconst FilterChip = ({ label, isSelected, onClick }) => (\n    <button \n        onClick={onClick}\n        className={`px-4 py-1.5 rounded-full border text-sm font-semibold transition-all duration-200 ${isSelected ? \'bg-primary/20 border-primary/0 text-primary\' : \'bg-surface-container border-outline/50 text-on-surface-variant hover:bg-surface-container-high hover:border-outline\'}`}>\n        {label}\n    </button>\n);\n\nconst PriceRangeSlider = ({ max, value, onChange }) => {\n    const progress = (value / max) * 100;\n    return (\n        <div className=\"px-4 pt-2\">\n            <div className=\"flex justify-between items-center mb-2\">\n                <label htmlFor=\"price\" className=\"font-semibold text-on-surface\">Precio</label>\n                <span className=\"px-3 py-1 text-sm font-bold rounded-full bg-primary/20 text-primary\">Hasta {Math.round(value)}€</span>\n            </div>\n            <input\n                type=\"range\"\n                id=\"price\"\n                min={0}\n                max={max}\n                value={value}\n                onChange={e => onChange(Number(e.target.value))}\n                className=\"w-full h-2 bg-transparent appearance-none cursor-pointer\"\n                style={{ \n                    background: `linear-gradient(to right, var(--md-sys-color-primary) ${progress}%, var(--md-sys-color-surface-container-highest) ${progress}%)`,\n                }}\n            />\n        </div>\n    );\n};\n\nconst FilterPanel = ({ isOpen, onClose, availableFilters, activeFilters, onFilterChange, onResetFilters, priceFilter, onPriceChange, maxPrice }) => {\n    const panelRef = useRef();\n    useEffect(() => {\n        if (isOpen) {\n            gsap.to(panelRef.current, { x: 0, duration: 0.5, ease: \'expo.out\' });\n            gsap.to(\".filter-backdrop\", { autoAlpha: 1, duration: 0.5 });\n        } else {\n            gsap.to(panelRef.current, { x: \'100%\', duration: 0.5, ease: \'expo.in\' });\n            gsap.to(\".filter-backdrop\", { autoAlpha: 0, duration: 0.5 });\n        }\n    }, [isOpen]);\n\n    const FilterGroup = ({ title, options, filterKey }) => (\n        <div className=\"py-4 border-b border-outline/30\">\n            <h4 className=\"font-semibold text-on-surface mb-3 px-4\">{title}</h4>\n            <div className=\"flex flex-wrap gap-2 px-4\">\n                {options.map(option => (\n                    <FilterChip key={option} label={option} isSelected={activeFilters[filterKey]?.includes(option)} onClick={() => onFilterChange(filterKey, option)} />\n                ))}\n            </div>\n        </div>\n    );\n\n    if (!isOpen && !panelRef.current) return null;\n\n    return (\n        <div className=\"fixed inset-0 z-40 pointer-events-none\">\n            <div className=\"filter-backdrop fixed inset-0 bg-black/40 opacity-0\" onClick={onClose} />\n            <div ref={panelRef} className=\"fixed top-0 right-0 h-full w-full max-w-sm bg-surface-container shadow-2xl z-50 flex flex-col pointer-events-auto transform translate-x-full\">\n                <div className=\"flex items-center justify-between p-4 border-b border-outline\">\n                    <h3 className=\"text-lg font-bold text-on-surface\">Filtros</h3>\n                    <button onClick={onClose} className=\"p-2 rounded-full hover:bg-surface-container-high transition-colors\"><CloseIcon /></button>\n                </div>\n                <div className=\"flex-grow overflow-y-auto\">\n                    <div className=\"py-4 border-b border-outline/30\"><PriceRangeSlider max={maxPrice} value={priceFilter} onChange={onPriceChange} /></div>\n                    {availableFilters.sizes?.length > 0 && <FilterGroup title=\"Talla\" options={availableFilters.sizes} filterKey=\"size\" />}\n                    {availableFilters.eventTypes?.length > 0 && <FilterGroup title=\"Tipo de Evento\" options={availableFilters.eventTypes} filterKey=\"eventType\" />}\n                    {availableFilters.conditions?.length > 0 && <FilterGroup title=\"Condición\" options={availableFilters.conditions} filterKey=\"condition\" />}\n                </div>\n                <div className=\"p-4 border-t border-outline flex items-center gap-2\">\n                    <button onClick={onResetFilters} className=\"w-full h-11 rounded-full border border-outline text-on-surface-variant font-bold hover:bg-surface-container-high transition-colors text-sm\">Limpiar Filtros</button>\n                </div>\n            </div>\n        </div>\n    );\n};\n\n// --- PÁGINA DE BÚSQUEDA PRINCIPAL ---\nconst SearchPage = ({ favorites, onToggleFavorite }) => {\n  const { docs: allSuits, loading, error } = useRealtimeDB(\'trajes\');\n  const { containerRef } = useSuitAnimations();\n  const location = useLocation();\n\n  const normalizedSuits = useMemo(() => allSuits.map(s => ({ ...s, price: s.price || s.precioPorDia, name: s.name || s.nombre, eventType: s.eventType ? s.eventType.charAt(0).toUpperCase() + s.eventType.slice(1) : \'No especificado\', condition: s.condition ? s.condition.charAt(0).toUpperCase() + s.condition.slice(1) : \'No especificado\' })), [allSuits]);\n\n  const [searchTerm, setSearchTerm] = useState(\'\');\n  const [sortBy, setSortBy] = useState(\'default\');\n  const [filters, setFilters] = useState({ size: [], eventType: [], condition: [] });\n  const [priceFilter, setPriceFilter] = useState(0);\n  const [isFilterPanelOpen, setIsFilterPanelOpen] = useState(false);\n\n  const { availableFilters, maxPrice } = useMemo(() => {\n    const sizes = new Set(), eventTypes = new Set(), conditions = new Set();\n    let maxP = 0;\n    normalizedSuits.forEach(s => {\n        if (s.size) sizes.add(s.size);\n        if (s.eventType) eventTypes.add(s.eventType);\n        if (s.condition) conditions.add(s.condition);\n        if (s.price > maxP) maxP = s.price;\n    });\n    return {\n        availableFilters: { sizes: [...sizes].sort((a,b) => a.localeCompare(b, undefined, {numeric: true})), eventTypes: [...eventTypes].sort(), conditions: [...conditions].sort() },\n        maxPrice: maxP > 0 ? maxP : 500\n    };\n  }, [normalizedSuits]);\n\n  useEffect(() => { setPriceFilter(maxPrice); }, [maxPrice]);\n  useEffect(() => { setSearchTerm(new URLSearchParams(location.search).get(\'q\') || \'\'); }, [location.search]);\n\n  const processedSuits = useMemo(() => {\n    let suits = [...normalizedSuits];\n    if (searchTerm) {\n        const lowerTerm = searchTerm.toLowerCase();\n        suits = suits.filter(s => Object.values(s).some(val => String(val).toLowerCase().includes(lowerTerm)));\n    }\n    suits = suits.filter(s => {\n        const sizeMatch = filters.size.length === 0 || filters.size.includes(s.size);\n        const eventMatch = filters.eventType.length === 0 || filters.eventType.includes(s.eventType);\n        const conditionMatch = filters.condition.length === 0 || filters.condition.includes(s.condition);\n        const priceMatch = s.price <= priceFilter;\n        return sizeMatch && eventMatch && conditionMatch && priceMatch;\n    });\n    if (sortBy === \'price-asc\') suits.sort((a, b) => a.price - b.price);\n    else if (sortBy === \'price-desc\') suits.sort((a, b) => b.price - a.price);\n    return suits;\n  }, [normalizedSuits, searchTerm, sortBy, filters, priceFilter]);\n\n  const handleFilterChange = (key, value) => {\n    setFilters(prev => ({ ...prev, [key]: prev[key].includes(value) ? prev[key].filter(v => v !== value) : [...prev[key], value] }));\n  };\n\n  const resetFilters = () => {\n      setFilters({ size: [], eventType: [], condition: [] });\n      setPriceFilter(maxPrice);\n  }\n\n  const activeFilterCount = Object.values(filters).flat().length + (priceFilter < maxPrice ? 1 : 0);\n\n  const renderResults = () => {\n    if (loading) return <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8\">{[...Array(6)].map((_, i) => <SuitCardSkeleton key={i} />)}</div>;\n    if (error) return <p className=\"text-center text-error p-8\">Error al cargar los trajes.</p>;\n    if (processedSuits.length === 0 && !loading) return <div className=\"text-center py-16 px-6 bg-surface-container rounded-3xl\"><h2 className=\"text-xl font-semibold text-on-surface\">No se encontraron resultados</h2><p className=\"text-on-surface-variant mt-2\">Intenta ajustar tu búsqueda o filtros para encontrar lo que buscas.</p></div>;\n    return <div ref={containerRef} className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8\">{processedSuits.map(suit => <SuitCard key={suit.id} suit={suit} isFavorite={favorites.has(suit.id)} onToggleFavorite={onToggleFavorite} />)}</div>;\n  }\n\n  return (\n    <>\n      <FilterPanel isOpen={isFilterPanelOpen} onClose={() => setIsFilterPanelOpen(false)} availableFilters={availableFilters} activeFilters={filters} onFilterChange={handleFilterChange} onResetFilters={resetFilters} priceFilter={priceFilter} onPriceChange={setPriceFilter} maxPrice={maxPrice} />\n      <div className=\"w-full max-w-7xl mx-auto flex flex-col space-y-8 px-4 sm:px-6 lg:px-8 py-8\">\n          <header className=\"flex flex-col sm:flex-row items-center justify-between gap-4\">\n              <div className=\"flex-grow w-full\">\n                  {/* Aquí podría ir la barra de búsqueda que ya tienes en el Header */}\n              </div>\n              <div className=\"flex items-center gap-2 w-full sm:w-auto\">\n                <button onClick={() => setIsFilterPanelOpen(true)} className=\"relative flex-grow sm:flex-grow-0 flex items-center justify-center space-x-2 h-10 px-4 rounded-full bg-surface-container-high hover:bg-surface-container-highest transition-colors text-sm\">\n                  <AnimatedFilterIcon />\n                  <span className=\"font-medium text-on-surface\">Filtros</span>\n                  {activeFilterCount > 0 && <div className=\"absolute -top-1 -right-1 h-5 w-5 grid place-items-center rounded-full bg-primary text-xs font-bold text-on-primary animate-pop-in\">{activeFilterCount}</div>}\n                </button>\n                <div className=\"flex-grow sm:flex-grow-0\"><SortDropdown selected={sortBy} onSelect={setSortBy} /></div>\n              </div>\n          </header>\n          <main className=\"min-h-[400px]\">{renderResults()}</main>\n      </div>\n    </>\n  );\n};\n\nexport default SearchPage;\n